<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Intel XPU Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        .status-ok { color: green; }
        .status-unknown { color: orange; }
        .chart-container { width: 600px; height: 300px; margin: 20px 0; }
        button { margin: 5px; padding: 8px 16px; }
        .lang-switch { float: right; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1 id="title">Intel XPU Web Monitor</h1>
    <div class="lang-switch">
        <button onclick="switchLanguage('en')">English</button>
        <button onclick="switchLanguage('zh')">中文</button>
    </div>

    <!-- 设备列表 -->
    <h2 id="devices-title">GPU Devices</h2>
    <table id="devices-table">
        <thead><tr><th id="id-header">ID</th><th id="name-header">Name</th><th id="pci-header">PCI BDF</th><th id="status-header">Status</th></tr></thead>
        <tbody></tbody>
    </table>

    <!-- 实时统计 -->
    <h2 id="stats-title">Real-time Stats (Device 0)</h2>
    <div id="stats-container"></div>

    <!-- 健康状态 -->
    <h2 id="health-title">Health Status</h2>
    <div id="health-container"></div>

    <!-- 进程列表 -->
    <h2 id="process-title">GPU Processes</h2>
    <div id="process-container"></div>

    <!-- 控制面板 -->
    <h2 id="control-title">Monitoring Control</h2>
    <button id="start-button" onclick="startContinuousMonitor()">Start Continuous Monitor</button>
    <button id="stop-button" onclick="stopContinuousMonitor()">Stop Continuous Monitor</button>
    <span id="monitor-status">Stopped</span>

    <!-- 历史图表 -->
    <h2 id="history-title">Historical Power & Temperature</h2>
    <div class="chart-container">
        <canvas id="historyChart"></canvas>
    </div>

    <script>
        let monitorInterval = null;
        const history = { timestamps: [], power: [], temp: [] };
        let chart = null;
        let currentLanguage = 'en';
        let currentDeviceId = 0; // 当前选中的设备 ID，默认 0

        // Language translations
        const translations = {
            en: {
                title: "Intel XPU Web Monitor",
                devicesTitle: "GPU Devices",
                idHeader: "ID",
                nameHeader: "Name",
                pciHeader: "PCI BDF",
                statusHeader: "Status",
                statsTitle: "Real-time Stats",
                healthTitle: "Health Status",
                processTitle: "GPU Processes",
                controlTitle: "Monitoring Control",
                startButton: "Start Continuous Monitor",
                stopButton: "Stop Continuous Monitor",
                historyTitle: "Historical Power & Temperature",
                statusOnline: "Online",
                statusStopped: "Stopped",
                statusRunning: "Running...",
                metricPower: "Power (W)",
                metricFrequency: "Frequency (MHz)",
                metricTemperature: "Temperature (°C)",
                metricMemoryUtil: "Memory Utilization (%)",
                healthComponent: "Component",
                healthStatus: "Status",
                healthDescription: "Description",
                healthOK: "OK"
            },
            zh: {
                title: "Intel XPU 网页监控器",
                devicesTitle: "GPU 设备列表",
                idHeader: "设备 ID",
                nameHeader: "设备名称",
                pciHeader: "PCI BDF 地址",
                statusHeader: "状态",
                statsTitle: "实时统计信息",
                healthTitle: "健康状态",
                processTitle: "进程列表",
                controlTitle: "监控控制",
                startButton: "开始持续监控",
                stopButton: "停止持续监控",
                historyTitle: "功率和温度历史数据",
                statusOnline: "在线",
                statusStopped: "已停止",
                statusRunning: "运行中...",
                metricPower: "功率 (W)",
                metricFrequency: "频率 (MHz)",
                metricTemperature: "温度 (°C)",
                metricMemoryUtil: "内存使用率 (%)",
                healthComponent: "组件",
                healthStatus: "状态",
                healthDescription: "描述",
                healthOK: "正常"
            }
        };

        // 切换语言
        function switchLanguage(lang) {
            currentLanguage = lang;
            const t = translations[lang];
            
            // 更新页面文本
            document.getElementById('title').textContent = t.title;
            document.getElementById('devices-title').textContent = t.devicesTitle;
            document.getElementById('id-header').textContent = t.idHeader;
            document.getElementById('name-header').textContent = t.nameHeader;
            document.getElementById('pci-header').textContent = t.pciHeader;
            document.getElementById('status-header').textContent = t.statusHeader;
            document.getElementById('stats-title').textContent = `${t.statsTitle} (Device ${currentDeviceId})`;
            document.getElementById('health-title').textContent = t.healthTitle;
            document.getElementById('process-title').textContent = t.processTitle;
            document.getElementById('control-title').textContent = t.controlTitle;
            document.getElementById('start-button').textContent = t.startButton;
            document.getElementById('stop-button').textContent = t.stopButton;
            document.getElementById('history-title').textContent = t.historyTitle;
            
            // 重新获取数据以更新显示
            fetchDevices();
            fetchStats();
            fetchHealth();
            fetchProcesses();
        }

        // 初始化图表
        function initChart() {
            const ctx = document.getElementById('historyChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: history.timestamps,
                    datasets: [
                        {
                            label: currentLanguage === 'zh' ? '功率 (W)' : 'Power (W)',
                            data: history.power,
                            borderColor: 'blue',
                            fill: false
                        },
                        {
                            label: currentLanguage === 'zh' ? '核心温度 (°C)' : 'Core Temp (°C)',
                            data: history.temp,
                            borderColor: 'red',
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { 
                            display: true, 
                            title: { 
                                display: true, 
                                text: currentLanguage === 'zh' ? '时间' : 'Time' 
                            } 
                        },
                        y: { beginAtZero: false }
                    }
                }
            });
        }

        // 切换当前监控的设备
        function selectDevice(deviceId) {
            currentDeviceId = deviceId;
            const t = translations[currentLanguage];
            document.getElementById('stats-title').textContent = `${t.statsTitle} (Device ${currentDeviceId})`;
            fetchStats();
            fetchHealth();
        }

        // 获取设备列表
        async function fetchDevices() {
            const res = await fetch('/devices');
            const data = await res.json();
            const tbody = document.querySelector('#devices-table tbody');
            tbody.innerHTML = '';
            const t = translations[currentLanguage];
            data.devices.forEach(d => {
                const row = `<tr onclick="selectDevice(${d.device_id})" style="cursor: pointer;">
                    <td>${d.device_id}</td>
                    <td>${d.device_name}</td>
                    <td>${d.pci_bdf_address}</td>
                    <td class="status-ok">${t.statusOnline}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        // 获取实时 stats（当前设备）
        async function fetchStats() {
            const res = await fetch(`/stats/${currentDeviceId}`);
            const data = await res.json();
            const container = document.getElementById('stats-container');
            const t = translations[currentLanguage];
            let html = '<table><thead><tr><th>' + (currentLanguage === 'zh' ? '指标' : 'Metric') + '</th><th>' + (currentLanguage === 'zh' ? '数值' : 'Value') + '</th></tr></thead><tbody>';
            data.device_level.forEach(m => {
                let value = m.value;
                let metricName = m.metrics_type.replace('XPUM_STATS_', '').replace(/_/g, ' ');
                if (m.metrics_type === 'XPUM_STATS_POWER') {
                    value += ' W';
                    metricName = currentLanguage === 'zh' ? t.metricPower : t.metricPower;
                }
                else if (m.metrics_type === 'XPUM_STATS_GPU_FREQUENCY') {
                    value += ' MHz';
                    metricName = currentLanguage === 'zh' ? t.metricFrequency : t.metricFrequency;
                }
                else if (m.metrics_type === 'XPUM_STATS_GPU_CORE_TEMPERATURE') {
                    value += ' °C';
                    metricName = currentLanguage === 'zh' ? t.metricTemperature : t.metricTemperature;
                }
                else if (m.metrics_type === 'XPUM_STATS_MEMORY_UTILIZATION') {
                    value += ' %';
                    metricName = currentLanguage === 'zh' ? t.metricMemoryUtil : t.metricMemoryUtil;
                }
                html += `<tr><td>${metricName}</td><td>${value}</td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // 获取健康状态（当前设备）
        async function fetchHealth() {
            const res = await fetch(`/health/${currentDeviceId}`);
            const data = await res.json();
            const container = document.getElementById('health-container');
            const t = translations[currentLanguage];
            let html = '<table><thead><tr><th>' + t.healthComponent + '</th><th>' + t.healthStatus + '</th><th>' + t.healthDescription + '</th></tr></thead><tbody>';
            for (const [key, val] of Object.entries(data)) {
                if (key === 'device_id') continue;
                const statusClass = val.status === 'OK' ? 'status-ok' : 'status-unknown';
                const statusText = val.status === 'OK' ? (currentLanguage === 'zh' ? t.healthOK : 'OK') : val.status;
                html += `<tr><td>${key.replace(/_/g, ' ')}</td><td class="${statusClass}">${statusText}</td><td>${val.description || ''}</td></tr>`;
            }
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // 获取进程列表（当前设备）
        async function fetchProcesses() {
            const res = await fetch(`/ps/${currentDeviceId}`);
            const data = await res.json();
            const container = document.getElementById('process-container');

            // 兼容不同 JSON 结构：优先找常见字段，其次尝试直接当数组
            let processes = [];
            if (Array.isArray(data.process_list)) {
                processes = data.process_list;
            } else if (Array.isArray(data.processes)) {
                processes = data.processes;
            } else if (Array.isArray(data)) {
                processes = data;
            }

            if (!processes.length) {
                container.innerHTML = currentLanguage === 'zh'
                    ? '<p>当前设备没有正在使用 GPU 的进程。</p>'
                    : '<p>No GPU processes are running on the current device.</p>';
                return;
            }

            // 动态根据返回字段生成表头/表格，保证与 xpumcli JSON 对齐
            const keys = Object.keys(processes[0]);
            let html = '<table><thead><tr>';
            keys.forEach(k => {
                html += `<th>${k}</th>`;
            });
            html += '</tr></thead><tbody>';

            processes.forEach(p => {
                html += '<tr>';
                keys.forEach(k => {
                    html += `<td>${p[k]}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // 持续监控任务
        function startContinuousMonitor() {
            if (monitorInterval) return;
            monitorInterval = setInterval(async () => {
                await fetchStats();
                await fetchHealth();
                await fetchProcesses();

                // 记录历史（仅保留最近 50 点）
                const statsRes = await fetch(`/stats/${currentDeviceId}`);
                const stats = await statsRes.json();
                const now = new Date().toLocaleTimeString();
                let power = 0, temp = 0;
                stats.device_level.forEach(m => {
                    if (m.metrics_type === 'XPUM_STATS_POWER') power = m.value;
                    if (m.metrics_type === 'XPUM_STATS_GPU_CORE_TEMPERATURE') temp = m.value;
                });

                history.timestamps.push(now);
                history.power.push(power);
                history.temp.push(temp);

                if (history.timestamps.length > 50) {
                    history.timestamps.shift();
                    history.power.shift();
                    history.temp.shift();
                }

                if (chart) {
                    chart.data.labels = history.timestamps;
                    chart.data.datasets[0].data = history.power;
                    chart.data.datasets[1].data = history.temp;
                    chart.data.datasets[0].label = currentLanguage === 'zh' ? '功率 (W)' : 'Power (W)';
                    chart.data.datasets[1].label = currentLanguage === 'zh' ? '核心温度 (°C)' : 'Core Temp (°C)';
                    chart.options.scales.x.title.text = currentLanguage === 'zh' ? '时间' : 'Time';
                    chart.update();
                }

                document.getElementById('monitor-status').textContent = currentLanguage === 'zh' ? t.statusRunning : 'Running...';
            }, 2000); // 每2秒刷新
            const t = translations[currentLanguage];
            document.getElementById('monitor-status').textContent = currentLanguage === 'zh' ? t.statusRunning : 'Running...';
        }

        function stopContinuousMonitor() {
            if (monitorInterval) {
                clearInterval(monitorInterval);
                monitorInterval = null;
                const t = translations[currentLanguage];
                document.getElementById('monitor-status').textContent = currentLanguage === 'zh' ? t.statusStopped : 'Stopped';
            }
        }

        // 初始化
        window.onload = async () => {
            initChart();
            await fetchDevices();
            await fetchStats();
            await fetchHealth();
            await fetchProcesses();
        };
    </script>
</body>
</html>